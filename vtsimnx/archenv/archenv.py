"""archenv: 建築環境（気象・放射・快適性）の計算ユーティリティ群

主な機能:
- 風向・風圧の算出
- 夜間放射量の算出
- 太陽位置・方位別日射量の算出（簡易/astropy）
- PMV/PPD、Fungal Index の算出

単位の原則:
- 角度: 度
- 温度: 摂氏
- 放射・日射: W/m2（必要に応じて関数内で換算）
- 風速: m/s
"""
import pandas as pd
import numpy as np
import math
import datetime

############################################################################################################################
# 定数
############################################################################################################################
Air_Cp   = 1.005    # 空気の定圧比熱 [kJ/(kg·K)]
Vap_Cp   = 1.846    # 水蒸気の定圧比熱 [kJ/(kg·K)]
Vap_L    = 2501.1   # 水蒸気の蒸発潜熱 [kJ/kg]

Sigma    = 4.88e-8  # ステファン・ボルツマン定数
Solar_I  = 1365     # 太陽定数 [W/m2]

capa_air = lambda v: v * 1.005 * 1.2 * 1000  # 容積 v[m3] の空気の熱容量 [J/K]

############################################################################################################################
#湿り空気の状態
############################################################################################################################
# 空気密度 ρ [kg/m3] の近似（理想気体：ρ ≒ 353.25 / (t+273.15)）
# t は気温 [℃]、353.25 は 101325/287 ≒ 353.25（標準大気圧/気体定数）
get_rho = lambda sita:   353.25 / (sita + 273.15)

# 絶対温度 T [K]
T      = lambda t: t + 273.15

# 飽和水蒸気圧近似で用いる補助変数（100℃と t℃ の絶対温度比）
T_dash = lambda t: T(100.0) / T(t)

# 単位換算
Wh_to_MJ   = lambda v: v * 3.6 / 1000   # Wh → MJ
MJ_to_Wh   = lambda v: v * 1000 / 3.6   # MJ → Wh

# 飽和水蒸気圧 ps の対数近似の核（Magnus/Tetens に類する式）
# f(t) は log10(ps[hPa]) を返すスカラー関数
f  = lambda t:    - 7.90298 * (T_dash(t) - 1) \
                  + 5.02808 * np.log10(T_dash(t)) \
                  - 1.3816e-7 * (np.power(10, 11.344  * (1 - 1 / T_dash(t))) - 1) \
                  + 8.1328e-3 * (np.power(10, -3.4919 * (T_dash(t) - 1)) - 1) \
                  + np.log10(1013.246)

# 絶対湿度 x [kg/kg'] → 水蒸気圧 e[Pa] への変換に使う補助
f_from_x = lambda x: (x / 1000 * 101325) / (x / 1000 + 0.622)

# 飽和水蒸気圧 ps [Pa]（hPa → Pa へ ×100）
ps = lambda t:    np.power(10, f(t)) * 100

# 水蒸気圧 e [Pa]（相対湿度 h[%] から）
e  = lambda t, h: h / 100 * ps(t)

# 絶対湿度 x [kg/kg']（水蒸気の混合比）
x  = lambda t, h: 0.622 * (e(t, h) / (101325 - e(t, h)))

# 顕熱エンタルピ hs [kJ/kg]（Air_Cp は kJ/(kg·K) 前提）
hs = lambda t:    Air_Cp * t

# 潜熱エンタルピ hl [kJ/kg]：x·(潜熱 + 水蒸気顕熱)
hl = lambda t, h: x(t, h) * (Vap_L + Vap_Cp * t)

# 全熱エンタルピ ht [kJ/kg]
ht = lambda t, h: hs(t) + hl(t, h)

############################################################################################################################
# 共通ヘルパー
############################################################################################################################
def _alt_deg_from_sin(sin_alt):
    """sin(仰角) から仰角[deg]を求める（数値誤差をクリップ）"""
    return np.degrees(np.arcsin(np.clip(sin_alt, -1.0, 1.0)))


def _az_deg_from_sin_cos(sin_az, cos_az):
    """sin/ cos から方位角[deg]を求める（arctan2 で象限処理込み）"""
    return np.degrees(np.arctan2(sin_az, cos_az))

############################################################################################################################
#（以下は共通のみを残し、機能別は wind.py / nocturnal.py / solar.py / comfort.py に分離）
############################################################################################################################